parameters:
  terraformWorkingDirectory: 'terraform/sample'

steps:
  - checkout: self

  - task: PowerShell@2
    displayName: 'Install Terraform (portable)'
    inputs:
      targetType: 'inline'
      script: |
        $ErrorActionPreference = "Stop"
        $version = "1.6.6"
        $arch = "amd64"
        $os = "windows"
        $zipName = "terraform_${version}_${os}_${arch}.zip"
        $url = "https://releases.hashicorp.com/terraform/${version}/${zipName}"

        $toolsDir = "$(Agent.ToolsDirectory)\terraform\$version"
        New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null
        $zipPath = Join-Path $toolsDir $zipName

        Write-Host "Downloading Terraform $version from $url"
        Invoke-WebRequest -Uri $url -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $toolsDir -Force
        Write-Host "##vso[task.prependpath]$toolsDir"
        terraform -version

  - task: PowerShell@2
    displayName: 'Terraform fmt (check)'
    inputs:
      targetType: 'inline'
      script: |
        cd ${{ parameters.terraformWorkingDirectory }}
        terraform fmt -check -recursive

  - task: PowerShell@2
    displayName: 'Terraform init'
    inputs:
      targetType: 'inline'
      script: |
        cd ${{ parameters.terraformWorkingDirectory }}
        terraform init -backend=false

  - task: PowerShell@2
    displayName: 'Terraform validate'
    inputs:
      targetType: 'inline'
      script: |
        cd ${{ parameters.terraformWorkingDirectory }}
        terraform validate
